name: CI
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release
jobs:
  build:
    # The CMake configure and build commands are platform agnostic and should work equally well on Windows or Mac.
    # You can convert this to a matrix build if you need cross-platform coverage.
    # See: https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/.ccache/linux
        key: linux-ccache-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: linux-ccache-
    - name: install_dependencies
      run: |
          sudo apt-get update -y -qq
          sudo apt-get install -y -qq libsdl2-dev ninja-build ccache
    - name: Configure CMake
      # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
      # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
      env:
        CCACHE_DIR: ${{ github.workspace }}/.ccache/linux
        CCACHE_BASEDIR: ${{ github.workspace }}
      run: cmake -B ${{github.workspace}}/build -GNinja -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DDPPC_68K_DEBUGGER=ON -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
    - name: Build
      # Build your program with the given configuration
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}} --parallel
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: DingusPPC-LINUX
        path: ${{github.workspace}}/build/bin
    - name: Test
      working-directory: ${{github.workspace}}/build
      # Execute tests defined by the CMake configuration.
      # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail
      run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ github.job }}
        path: |
          ${{ github.workspace }}/build/Testing/Temporary/LastTest.log
          ${{ github.workspace }}/build/CMakeFiles/CMakeOutput.log
          ${{ github.workspace }}/build/CMakeFiles/CMakeError.log
        if-no-files-found: ignore

  build-macos:
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-latest
            arch: arm64
            brew_prefix: /opt/homebrew
          - runner: macos-15-intel
            arch: x86_64
            brew_prefix: /usr/local
    runs-on: ${{ matrix.runner }}
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/.ccache/${{ matrix.arch }}
        key: macos-${{ matrix.runner }}-${{ matrix.arch }}-ccache-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          macos-${{ matrix.runner }}-${{ matrix.arch }}-ccache-
          macos-ccache-
    - name: install_dependencies
      run: |
        brew update
        brew install sdl2 ninja ccache
    - name: Configure CMake
      env:
        CCACHE_DIR: ${{ github.workspace }}/.ccache/${{ matrix.arch }}
        CCACHE_BASEDIR: ${{ github.workspace }}
      run: |
        export PATH="${{ matrix.brew_prefix }}/opt/ccache/libexec:$PATH"
        cmake -B ${{github.workspace}}/build -GNinja -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DDPPC_68K_DEBUGGER=ON -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }}
    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}} --parallel
    - name: Test
      working-directory: ${{github.workspace}}/build
      run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ github.job }}-${{ matrix.arch }}
        path: |
          ${{ github.workspace }}/build/Testing/Temporary/LastTest.log
          ${{ github.workspace }}/build/CMakeFiles/CMakeOutput.log
          ${{ github.workspace }}/build/CMakeFiles/CMakeError.log
        if-no-files-found: ignore
    - name: Upload artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: DingusPPC-macOS-${{ matrix.arch }}
        path: ${{github.workspace}}/build/bin

  build-windows:
    runs-on: windows-latest
    timeout-minutes: 45
    strategy:
      matrix:
        cache-name: [msys64-cache]
    env:
      MSYSTEM: MINGW64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.ccache/msys
          key: windows-msys-ccache-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: windows-msys-ccache-
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            bison
            diffutils
            flex
            tar
            doxygen
            cmake
            wget
            git
            grep
            make
            rsync
            ninja
            glib2-devel
            patch
            sed
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-binutils
            mingw-w64-x86_64-doxygen
            mingw-w64-x86_64-capstone
            mingw-w64-x86_64-ccache
            mingw-w64-x86_64-curl
            mingw-w64-x86_64-cyrus-sasl
            mingw-w64-x86_64-dtc
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-gnutls
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-libgcrypt
            mingw-w64-x86_64-libjpeg-turbo
            mingw-w64-x86_64-libnfs
            mingw-w64-x86_64-libpng
            mingw-w64-x86_64-libssh
            mingw-w64-x86_64-libtasn1
            mingw-w64-x86_64-libusb
            mingw-w64-x86_64-lzo2
            mingw-w64-x86_64-libslirp
            mingw-w64-x86_64-nettle
            mingw-w64-x86_64-clang
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pixman
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-python
            mingw-w64-x86_64-SDL2
            mingw-w64-x86_64-SDL2_image
            mingw-w64-x86_64-snappy
            mingw-w64-x86_64-spice
            mingw-w64-x86_64-usbredir
            mingw-w64-x86_64-zstd
            mingw-w64-x86_64-make
      - name: Build
        shell: msys2 {0}
        run: |
          echo "Running build at $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          export CHERE_INVOKING=yes
          export MSYS=winsymlinks:native
          export CCACHE_BASEDIR="${GITHUB_WORKSPACE}"
          export CCACHE_DIR="${GITHUB_WORKSPACE}/.ccache/msys"
          export CCACHE_MAXSIZE="500M"
          export CCACHE_DEPEND=1
          export CC="ccache gcc"
          mkdir -p build
          cd build
          ccache --zero-stats || true
          cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DPPC_BUILD_PPC_TESTS=True ..
          ninja
          ccache --show-stats || true
          echo "Finished build at $(date -u +'%Y-%m-%dT%H:%M:%SZ')"

      - name: Test
        shell: msys2 {0}
        run: |
          cd build
          ctest --output-on-failure
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.job }}
          path: |
            ${{ github.workspace }}/build/Testing/Temporary/LastTest.log
            ${{ github.workspace }}/build/CMakeFiles/CMakeOutput.log
            ${{ github.workspace }}/build/CMakeFiles/CMakeError.log
          if-no-files-found: ignore

  vsbuild-CLANG:
    runs-on: windows-latest
    timeout-minutes: 45
    env:
      VCPKG_FEATURE_FLAGS: binarycaching
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    - name: Setup msbuild
      uses: microsoft/setup-msbuild@v1
    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: C:\vcpkg
        key: vcpkg-${{ hashFiles('vcpkg.json') }}
        restore-keys: vcpkg-
    - name: Install vcpkg
      shell: powershell
      run: |
        if (-Not (Test-Path 'C:\vcpkg')) {
          git clone https://github.com/microsoft/vcpkg C:\vcpkg
          C:\vcpkg\bootstrap-vcpkg.bat
        }
        C:\vcpkg\vcpkg.exe install --triplet x64-windows
    - name: Install Ninja
      run: choco install ninja -y
    - name: Build
      shell: cmd
      run: |
        mkdir build
        cd build
        call "%ProgramFiles%\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang-cl -DCMAKE_CXX_COMPILER=clang-cl -DPPC_BUILD_PPC_TESTS=True -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows ..
        ninja
    - name: Test
      if: success()
      working-directory: ${{github.workspace}}/build
      run: ctest -C Release --output-on-failure
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ github.job }}
        path: |
          ${{ github.workspace }}/build/Testing/Temporary/LastTest.log
          ${{ github.workspace }}/build/CMakeFiles/CMakeOutput.log
          ${{ github.workspace }}/build/CMakeFiles/CMakeError.log
        if-no-files-found: ignore
    - name: Upload artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: DingusPPC-CLANG
        path: ${{github.workspace}}/build/bin

  vsbuild-MSVC:
    runs-on: windows-latest
    timeout-minutes: 45
    env:
      VCPKG_FEATURE_FLAGS: binarycaching
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    - name: Setup msbuild
      uses: microsoft/setup-msbuild@v1
    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: C:\vcpkg
        key: vcpkg-${{ hashFiles('vcpkg.json') }}
        restore-keys: vcpkg-
    - name: Install vcpkg
      shell: powershell
      run: |
        if (-Not (Test-Path 'C:\vcpkg')) {
          git clone https://github.com/microsoft/vcpkg C:\vcpkg
          C:\vcpkg\bootstrap-vcpkg.bat
        }
        C:\vcpkg\vcpkg.exe install --triplet x64-windows
    - name: Install Ninja
      run: choco install ninja -y
    - name: Build
      shell: cmd
      run: |
        mkdir build
        cd build
        call "%ProgramFiles%\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DPPC_BUILD_PPC_TESTS=True -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows ..
        ninja
    - name: Test
      if: success()
      working-directory: ${{github.workspace}}/build
      run: ctest -C Release --output-on-failure
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ github.job }}
        path: |
          ${{ github.workspace }}/build/Testing/Temporary/LastTest.log
          ${{ github.workspace }}/build/CMakeFiles/CMakeOutput.log
          ${{ github.workspace }}/build/CMakeFiles/CMakeError.log
        if-no-files-found: ignore
    - name: Upload artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: DingusPPC-MSVC
        path: ${{github.workspace}}/build/bin

  vsbuild-MSVC-MSBUILD:
    runs-on: windows-latest
    timeout-minutes: 45
    env:
      VCPKG_FEATURE_FLAGS: binarycaching
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    - name: Setup msbuild
      uses: microsoft/setup-msbuild@v1
    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: C:\vcpkg
        key: vcpkg-${{ hashFiles('vcpkg.json') }}
        restore-keys: vcpkg-
    - name: Install vcpkg
      shell: powershell
      run: |
        if (-Not (Test-Path 'C:\vcpkg')) {
          git clone https://github.com/microsoft/vcpkg C:\vcpkg
          C:\vcpkg\bootstrap-vcpkg.bat
        }
        C:\vcpkg\vcpkg.exe install --triplet x64-windows
    - name: Build
      shell: cmd
      run: |
        mkdir build
        cd build
        call "%ProgramFiles%\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cmake -G "Visual Studio 17 2022" -DCMAKE_BUILD_TYPE=Release -DPPC_BUILD_PPC_TESTS=True -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows ..
        msbuild dingusppc.sln /m
    - name: Test
      if: success()
      working-directory: ${{github.workspace}}/build
      run: ctest -C Release --output-on-failure
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ github.job }}
        path: |
          ${{ github.workspace }}/build/Testing/Temporary/LastTest.log
          ${{ github.workspace }}/build/CMakeFiles/CMakeOutput.log
          ${{ github.workspace }}/build/CMakeFiles/CMakeError.log
        if-no-files-found: ignore
    - name: Upload artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: DingusPPC-MSBUILD
        path: ${{github.workspace}}/build/bin
